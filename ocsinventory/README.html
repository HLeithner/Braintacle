<!--
Documentation for Braintacle's patched version of OCS Inventory NG

$Id$

Copyright (C) 2011,2012 Holger Schletz <holger.schletz@web.de>

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along with
this program; if not, write to the Free Software Foundation, Inc.,
51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>Braintacle's patched version of OCS Inventory NG</title>
</head>
<body>
<h1>Braintacle's patched version of OCS Inventory NG</h1>

<h2>About this version</h2>

<p>
This is a patched version of <a href="http://ocsinventory-ng.org">OCS inventory NG</a>
2.0.5/1.3.3 that uses a database abstraction layer for all database access,
allowing to work with databases other than MySQL.
It was developed and tested with PostgreSQL, which is the recommended database for this version.
MySQL is also supported.
Other databases might work, but are entirely untested.
</p>
<p>
<strong>
This project is not provided by the OCS Inventory NG team.
Do not bother them with any issues you encounter with this version.
Use Braintacle's support tracker or mailing list instead.
</strong>
</p>
<p>
This version comes bundled with <a href="http://savannah.nongnu.org/projects/braintacle/">Braintacle</a>.
It is not a requirement for using Braintacle if you use MySQL &ndash;
Braintacle works with an original OCS Inventory NG database, too.
<p>
<strong>This version of the ocsreports console is deprecated.
It will be maintained for important bugfixes, but no longer receive any major upgrades.</strong>
Most notably, it will stick at version 1.3.3.
Version 2.x will not be ported.
New features will be implemented in the Braintacle console only.
</p>
<p>
The agent that runs on the clients does not make any direct database connections.
All interaction runs through the communication server via HTTP/HTTPS.
No special version of the agent is required for the modified server.
Use any of the <a href="http://www.ocsinventory-ng.org/en/download/download-agent.html">
OCS Inventory NG agents</a>.
</p>

<h3>Differences to the original version</h3>

<p>
Besides the different database access methods, more changes have been made to the code:
</p>
<ul>
<li>
Some
<a href="http://svn.savannah.nongnu.org/viewvc/*checkout*/trunk/schema/README.html?root=braintacle">
changes to the database schema</a> were necessary for portability.
Braintacle and its bundled communication server work with both schema types (Braintacle and OCS),
but an unmodified OCS Inventory NG installation will not work with the Braintacle schema.
</li>
<li>
The setup must be done manually, giving the administrator more control over the installation process.
This is better than having a script messing with the system, which might break things and makes uninstallation
more difficult.
Detailed installation instructions are given in this document.
</li>
<li>
The communication server can optionally log to syslog instead of an extra log file.
</li>
<li>
The workaround for <a href="https://bugs.launchpad.net/ocsinventory-windows-agent/+bug/530881">bug #530881</a> is included.
</li>
<li>
The caching feature is disabled by default.
Leave it disabled.
</li>
<li>
A lot of improvements under the hood.
</li>
</ul>


<h2>Installation</h2>

<h3>Install Braintacle first</h3>

<p>
This version cannot be run standalone.
It depends on a properly configured Braintacle installation.
In particular, the database.ini file needs to be set up for the schema manager (see below).
Refer to README.txt in Braintacle's base directory for instructions.
</p>

<h3>Create the database and user</h3>

<p>
If you don't already have the database set up somewhere, you need to create it along with a database user.
Install a PostgreSQL (recommended) or MySQL server, if not already available, and log into that
database server with superuser privileges (typically the 'postgres' user for PostgreSQL, 'root' for MySQL).
</p>
<p>
For PostgreSQL, run:
</p>
<p>
<code>
CREATE USER ocs WITH PASSWORD 'ocs';<br>
CREATE DATABASE braintacle OWNER ocs ENCODING 'UTF8';
</code>
</p>
<p>
For MySQL, run:
</p>
<p>
<code>
CREATE USER ocs IDENTIFIED BY 'ocs';<br>
CREATE DATABASE braintacle CHARACTER SET utf8;<br>
GRANT ALL ON braintacle.* TO ocs;
</code>
</p>
<p>
You can choose any database name, user name or password.
UTF8 encoding is strongly recommended.
</p>
<p>
To create and initialize the tables, log out from the database and run the schema manager script
in the <em>tools</em> directory:
</p>
<p>
<code>
php tools/schema-manager.php --force
</code>
</p>
<p>
This will also create a default account 'admin' with the password 'admin'.
This should be changed immediately.
Point your browser to the URL of your braintacle installation, log in and click 'Preferences', then 'Users'.
Click on 'Edit', enter a new password, and optionally a different user name.
</p>

<h3>Install the communication server</h3>

<h4>Requirements</h4>

<p>
The communication server requires an Apache installation.
Other web servers are not supported because it heavily relies on mod_perl and its interface to Apache internals.
mod_perl2 is available as a native package for most GNU/Linux distributions:
libapache2-mod-perl2 (Debian/Ubuntu), mod_perl (Fedora), apache2-mod_perl (Suse).
A Perl interpreter is installed by default most GNU/Linux distributions.
Some nonstandard perl modules are required.
There are several ways to install them, in preferred order:
</p>
<ol>
<li>
As a native package from a GNU/Linux distribution, see the table below
</li>
<li>
Via the <em>cpan</em> command line utility
</li>
<li>
Manual download from <a href="http://cpan.org">CPAN</a> (take care of dependencies for yourself)
</li>
</ol>
<table border="1">
<tr>
<th>Module</th><th>Debian/Ubuntu</th><th>Fedora</th><th>SUSE</th>
</tr>
<tr>
<td>Compress::Zlib</td><td>(already present)</td><td>perl-IO-Compress</td><td>?</td>
</tr>
<tr>
<td>DBI</td><td>libdbi-perl</td><td>perl-DBI</td><td>perl-DBI</td>
</tr>
<tr>
<td>DBD::Pg (PostgreSQL only)</td><td>libdbd-pg-perl</td><td>perl-DBD-Pg</td><td>perl-DBD-Pg</td>
</tr>
<tr>
<td>DBD::mysql (MySQL only)</td><td>libdbd-mysql-perl</td><td>perl-DBD-MySQL</td><td>perl-DBD-mysql</td>
</tr>
<tr>
<td>Apache::DBI</td><td>libapache-dbi-perl</td><td>perl-Apache-DBI</td><td>perl-Apache-DBI</td>
</tr>
<tr>
<td>Date::Calc</td><td>libdate-calc-perl</td><td>perl-Date-Calc</td><td>perl-Date-Calc</td>
</tr>
<tr>
<td>XML::Simple</td><td>libxml-simple-perl</td><td>perl-XML-Simple</td><td>perl-XML-Simple</td>
</tr>
<tr>
<td>Sys::Syslog (optional)</td><td>(already present)</td><td>(already present)</td><td>(already present)</td>
</tr>
<tr>
<td>SOAP::Lite (optional)</td><td>libsoap-lite-perl</td><td>perl-SOAP-Lite</td><td>perl-SOAP-Lite</td>
</tr>
<tr>
<td>XML::Entities (optional)</td><td>(not available, use CPAN)</td><td>perl-XML-Entities</td><td>perl-XML-Entities</td>
</tr>
</table>
<p>
If you have used an original OCS Inventory NG server before, most of these modules will probably already be installed.
Beware of the additional dependency on Date::Calc!
</p>
<p>
Sys::Syslog is only required if you want to use syslog instead of logging directly to a file (see below).
The last 2 modules are only required for the SOAP service.
This is optional and entirely untested.
</p>

<h4>Installation</h4>

<p>
Create a copy of the sample configuration file config/braintacle-server.conf.template and make it known to Apache.
If you don't run multiple virtual hosts or want to make the application accessible on all virtual hosts,
you can simply copy it to a directory where Apache will read it (typically /etc/apache2/conf.d or similar):
</p>
<p>
<code>
cp /usr/local/share/braintacle/config/braintacle-server.conf.template /etc/apache2/conf.d/braintacle-server.conf
</code>
</p>
<p>
To limit the application to a particular virtual host, copy the file somewhere else
and include it in the &lt;VirtualHost&gt; block:
</p>
<p>
<code>
Include /usr/local/share/braintacle/config/braintacle-server.conf
</code>
</p>
<p>
The PerlSwitches directive in that file has no effect inside a &lt;VirtualHost&gt; section.
Place it outside the section to make it work.
</p>
<p>
Create a copy of config/braintacle-server-app.conf.template in a place outside the Apache configuration:
</p>
<p>
<code>
cp /usr/local/share/braintacle/config/braintacle-server-app.conf.template /usr/local/share/braintacle/config/braintacle-server-app.conf
</code>
</p>
<p>
Edit both files to match your environment.
Do not edit the template files directly as they will be overwritten upon upgrading.
</p>
<p>
It is important that mod_perl is loaded before the file is included.
This is the case in most standard Apache setups where modules are set up before conf.d gets evaluated.
If mod_perl is loaded from a config file in the same directory, make sure that its name comes before
the Braintacle configuration file in alphabetical order.
Rename the file if necessary.
</p>
<p>
The braintacle-server-app.conf file contains your database password in cleartext
and should only be readable for your web server, for example:
</p>
<p>
<code>
chgrp www-data /usr/local/share/braintacle/config/braintacle-server-app.conf<br>
chmod 640 /usr/local/share/braintacle/config/braintacle-server-app.conf
</code>
</p>

<h4>Configuring logging</h4>

<p>
This version of the communication server contains a patch to support syslog instead of direct logging to a file.
This is enabled by default.
No further action is required for this configuration.
</p>
<p>
Note that the Sys::Syslog module is required to make this work.
It is typically present on *NIX systems, so that it works out of the box.
On Windows, it could be installed manually, but it's difficult to get usable output there.
It is recommended to set up a log file manually on Windows.
You can also do this on *NIX systems if you don't want to use syslog.
</p>
<p>
To set up a log file, create a directory for them with write permissions for the web server, and possibly
no read permissions for the rest of the world.
For example, the following would work for Debian:
</p>
<p>
<code>
mkdir /var/log/braintacle<br>
chown www-data:www-data /var/log/braintacle<br>
chmod 750 /var/log/braintacle
</code>
</p>
<p>
Other distributions might have different user and group names for the web server.
</p>
<p>
Now edit braintacle-server-app.conf and set OCS_OPT_LOGPATH to the directory you just created.
</p>
<p>
You may want to rotate the logs regularly to prevent them from growing infinitely.
A sample logrotate configuration file is shipped in config/logrotate.template.
Copy this file to /etc/logrotate.d/braintacle and edit it to suit your needs.
</p>

<h4>Starting the server</h4>

<p>
To finish installation, reload the Apache configuration.
Depending on your configuration, you may see some errors in the Apache log file like this:
</p>
<pre>
braintacle-server: Can't load SOAP::Transport::HTTP* - Web service will be unavailable
</pre>
<p>
These messages are harmless and can be ignored if you don't plan to use the SOAP service.
</p>

<h3>Installation of administration console (optional and deprecated)</h3>

<p>
The old administration console (ocsreports) is not needed for most everyday tasks.
It should not be used except for some operations not yet supported by the Braintacle console:
<ul>
<li>
Creating groups.
Braintacle can display and delete groups and manage manual membership and assigned packages,
but not yet create new groups.
</li>
<li>
Overriding global configuration for specific computers or groups.
The global configuration can already be done in Braintacle.
</li>
<li>
Defining and querying inventoried registry keys.
</li>
</ul>
<p>
Some other operations are intentionally not supported by Braintacle,
like multiple download servers or agent upload.
Do not use ocsreports for these operations &ndash; they are deprecated and untested.
</p>

<h4>Requirements</h4>

<p>
The database must already be set up with the schema manager.
</p>
<p>
You need the pgsql/mysql PHP extension.
It is avaliable as a package for GNU/Linux distributions:
<table border="1">
<tr>
<th>PHP extension</th><th>Debian/Ubuntu</th><th>Fedora</th><th>SUSE</th>
</tr>
<tr>
<td>pgsql</td><td>php5-pgsql</td><td>php-pgsql</td><td>php5-pgsql</td>
</tr>
<tr>
<td>mysql</td><td>php5-mysql</td><td>php-mysql</td><td>php5-mysql</td>
</tr>
</table>

<h4>Configuration</h4>

<ol>
<li>
Create a copy of config/ocsreports.conf.template and make it known to Apache.
Edit the file to suit your needs.
</li>
<li>
Copy config/dbconfig.inc.php.template to ocsinventory/ocsreports/dbconfig.inc.php
and edit it to match your database setup.
</li>
<li>
Since dbconfig.inc.php contains your database credentials, it should not be world readable.
It must of course be readable for your web server.
</li>
</ol>

<h2>Technical details</h2>

<p>The following information may be helpful if you try to hack the code yourself. If you just want to use it you can skip the rest of this document.</p>

<h3>Database Abstraction layers</h3>

<p>
The perl code uses the DBI class as an abstraction layer.
Making the driver configurable instead of hardcoding to "mysql" does most of the trick.
</p>
<p>
The PHP part is much trickier.
It uses native MySQL library functions which have to be changed one by one.
Since the MDB2 API is much different from the MySQL API, direct use would be a painful and error prone procedure.
So I wrote some wrapper functions <em>mdb2_foo()</em> to mimic the behaior of the corresponding <em>mysql_foo()</em> functions.
This way a simple search-and-replace operation brings us halfway to our goal.
See <em>ocsreports/require/function_mdb2.php</em> for supported functions and caveats.
</p>
<p>
There are some limitations:
</p>
<ul>
<li>Some functions are not strictly compatible with their mysql counterparts and require adjustments to the calling code. See the comments for details.</li>
<li><em>mdb2_query()</em> only supports SELECT, INSERT, UPDATE and DELETE operations. There were occasional uses of SHOW and ALTER TABLE, which are not portable. MDB2 provides abstraction for these operations. This required rewriting the code portion. The same operations replace <em>mysql_field_type()</em> and <em>mysql_fetch_field()</em>.</li>
<li>There is no <em>mdb2_fetch_array()</em> function. I could have implemented one, but using either <em>mdb2_fetch_assoc()</em> or <em>mdb2_fetch_row()</em> is cleaner and sufficient in most cases. There were a few cases where both associative and numeric indices werde needed. These are special cases where only the first entry is needed, so I wrote a workaround directly in the code.</li>
</ul>

<p>
Some functions have extra optional arguments for enhanced functionality.
For example, <em>mdb2_query()</em> supports prepared statements via 2 extra arguments.
Since these arguments are optional, it is still suitable as a drop-in replacement for <em>mysql_query()</em>.
</p>

<h3>SQL compatibility</h3>

<p>
Unfortunately, the API switch does only half of the job.
There were many MySQL-specific expressions present in the code.
This started with inconsistent quoting (MySQL allows single and double quotes for string literals, while standard SQL requires single quotes) and other obvious stuff like "LIMIT a,b" instead of standard "LIMIT b OFFSET a".
There were some less obvious issues like columns in GROUP BY clauses which are not present in the FROM clause (this is allowed by MySQL, but not standard SQL).
It even turned out that some of these grouping statements were completely unnecessary.
</p>
<p>
I converted the statements to all standard SQL, assuming this will be understood by all databases. MDB2's Function module helps increasing portability. Since the provided database backend can be queried at runtime, DBMS-specific extensions like PostgreSQLs ILIKE operator can be used without breaking compatibility with other DBMS.
</p>

<h3>Spelling of column identifiers</h3>

<p>
Another problem is case-sensitiveness of array/hash keys.
Whenever a database function returns an array (PHP) or hash (Perl) with column identifiers as keys, it's up to the API whether these are uppercase or lowercase.
PostgreSQL seems to return all lowercase identifiers, while MySQL seems to adapt the spelling from the query string (or table creation statement in case of <code>"SELECT * FROM...")</code>.
Unfortunately, <code>$foo['bar']</code> is not the same as <code>$foo['BAR']</code>.
The same applies to object members returned by <em>mdb2_fetch_object()</em>.
</p>
<p>
Since this behavior would make database applications effectively unportable, both DBI and MDB2 provide an option to convert identifiers to all uppercase or all lowercase.
It's then up to the application to use all uppercase or all lowercase throughout the code.
</p>
<p>
The perl code consistently uses uppercase spelling.
The only necessary step was turning on uppercase conversion globally.
</p>
<p>
The PHP code was not that friendly.
While the majority of the code uses lowercase spelling, there was a significant amount of uppercase use.
MDB2 converts the identifiers to lowercase.
Logging E_NOTICE messages helps spotting non-lowercase identifiers even for complex, dynamically generated queries.
Speaking of which...

<h3>Getting rid of E_NOTICE messages</h3>

<p>
Unfortunately, this code was developed with E_NOTICE logging turned off.
Turning it on initially resulted in tons of messages flooding the logfile, making it nearly impossible to find the real errors between all those mostly harmless ones.
Most of these result from situations like this:
</p>
<pre>
if ($_GET['foo'] == 'bar')...
</pre>
<p>
which drops an E_NOTICE if the parameter 'foo' is not present.
This is not an error &ndash; the code behaves just as expected.
I wrote a helper function called check_param() to handle this.
This workaround is quite clumsy and not a substitute for a more sophisticated parameter handling, but this would require a LOT more changes to the code, making it nearly impossible to merge future upstream changes.
</p>

<h3>Tracking down problems</h3>

<p>
If you observe erratic behavior, check your logfiles. The answer is probably out there. Many of the issues introduced by my patches result from code expecting uppercase indices (remember, they all get converted to lowercase). A less frequent class of bugs results from substituting <em>mysql_fetch_array()</em> and <em>MYSQL_FETCHMODE_BOTH</em> (the default) with either <em>mdb2_fetch_assoc()</em> (associative indices, sufficient in most cases) or <em>mdb2_fetch_row()</em> (numeric indices, not so often) in rare cases where both associative and numeric indices are actually needed. All these bugs are accompanied by an "undefined index" message. Thanks to the logged filename and line number, the source of the error is easily spotted and fixed.
</p>
<p>
Another problem with case-changed indices are case-sensitive string comparisions. These are harder to track down because they fail silently without an error message. Similarly, string comparisions at SQL level behave differently: in MySQL they are case insensitive while in PostgreSQL they are case sensitive.
</p>

</body>
</html>
