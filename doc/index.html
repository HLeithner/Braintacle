<!--
Braintacle main documentation

$Id$

Copyright (C) 2011,2012 Holger Schletz <holger.schletz@web.de>

This program is free software; you can redistribute it and/or modify it
under the terms of the GNU General Public License as published by the Free
Software Foundation; either version 2 of the License, or (at your option)
any later version.

This program is distributed in the hope that it will be useful, but WITHOUT
ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
FITNESS FOR A PARTICULAR PURPOSE. See the GNU General Public License for
more details.

You should have received a copy of the GNU General Public License along with
this program; if not, write to the Free Software Foundation, Inc.,
51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.
-->
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html;charset=utf-8">
<title>Braintacle documentation</title>
</head>
<body>

<h1>Braintacle documentation</h1>

<h2>Project website</h2>

<p>
Braintacle is hosted at <a href="http://savannah.nongnu.org/projects/braintacle">http://savannah.nongnu.org/projects/braintacle</a>.
</p>


<h2>What is it?</h2>

<p>
Braintacle is an alternative administration console for <a href="http://ocsinventory-ng.org">OCS Inventory NG</a>.
I wrote it for 2 reasons:
</p>
<ol>
<li>
<p>
I already had a PostgreSQL server in use, and I didn't like the idea of setting up a MySQL server just for OCS Inventory.
While the communication server component could be easily adapted due to the DBI abstraction layer,
the administration console uses MySQL functions directly.
</p>
<p>
I briefly considered rewriting a console application from scratch, but that would have been a lot of work.
Instead, I adapted the code to use the <a href="http://pear.php.net/package/MDB2/">MDB2</a> abstraction layer.
It turned out that there were other aspects of the code (mostly regarding security and debugging) which I wanted to have sorted out before using it.
</p>
<p>
As a result, the patch is very intrusive, making it difficult to keep up with future development.
</p>
</li>
<li>
<p>
While the patched version works well from a technical point of view, I got more and more frustrated
by the user interface.
In particular, the process of building and deploying packages involves repeating a lot of steps over and over again everytime a new software release is to be deployed.
This is not only annoying, but also error-prone.
</p>
<p>
This, among other minor annoyances, finally convinced me to pick up my initial idea of rewriting my own console with an improved workflow.
</p>
</li>
</ol>

<p>
Braintacle is planned to replace the original administration console completely.
It is far from complete yet, but already usable for most tasks.
</p>

<p>
The mentioned patched version of OCS Inventory NG comes bundled with Braintacle
in the <em>ocsinventory</em> directory. See the
<a href="http://svn.savannah.nongnu.org/viewvc/*checkout*/trunk/ocsinventory/README.Braintacle.html?root=braintacle">README.Braintacle.html</a>
file in the same directory for details.
Use of this modified version is recommended.
</p>

<h2>Advantages</h2>

<ul>
<li>
The package builder is much easier to use and provides features that the original console does not have.
Most notably, deploying a new version of an existing package is very easy:
just click on its name, upload the file, give it a new name and that's it.
See "<a href="#packagebuilder">Package builder</a>" for a full list of features.
</li>
<li>
Duplicates are much better to manage.
You can specify which type of information to merge, and you can blacklist asset tags too, not only serials and MAC addresses.
</li>
<li>
Access to the list of computers with a particular package status is easier, too.
</li>
<li>
Multiple packages can be deployed to a single computer in one step.
</li>
<li>
Software listings can be freed of clutter like these boring Windows updates and annoying Office 2007 subpackages.
See "<a href="#softwarefilter">software filter</a>" for details.
</li>
<li>
Software dictionaries are much easier to manage.
Extra categories are not supported yet &ndash; The dictionary manager is intended for software filters only.
</li>
<li>
Computers can be exported as XML, either individually via console or all at once via the <a href="#export.php">export tool</a>.
The XML files are similar to those generated locally by the agents, and suitable for import via the console or the ocsinventory-injector.pl script.
This simplifies data migration between different databases or data processing via external tools.
</li>
<li>
Braintacle uses the <a href="http://framework.zend.com">Zend Framework</a> which provides, among many other features, a database abstraction API.
Together with minor modifications to the communication server, this allows any supported database backend to be used, not only MySQL.
It was developed and tested with PostgreSQL.
Other supported DBMS should work, but have not been extensively tested yet.
I have designed the SQL commands to be portable, so I would not expect too many bad surprises.
</li>
<li>
Braintacle uses localization functions wherever possible.
Translation is provided by the well-known <a href="http://www.gnu.org/software/gettext/">gettext</a> standard.
English and german translations are included.
Other translations can easily be added and maintained using your favorite gettext tools.
</li>
<li>
I tried to keep the code as readable and understandable as possible.
It follows the recommended structure and coding standards for Zend Framework projects.
As a side-effect of the MVC architecture, the model classes provide an abstract API to all logical
objects (computers, packages etc.).
</li>
</ul>


<h2>Extra features and limitations</h2>

<h3>Login restrictions</h3>

<p>
Braintacle does not implement different access privileges.
To prevent unprivileged users from unauthorized access, only administrators can log in.
</p>
<p>
Braintacle requires an account with an MD5 hashed password.
This is the default when creating an account or changing the password with OCSInventory console.
If the database is populated with the bundled OCSInventory console or schema-manager.php, the default account will already have a hashed password.
</p>

<h3><a name="packagebuilder">Package builder</a></h3>

<h4>Editing packages</h4>

<p>
Braintacle's most notable feature is the ability to edit existing packages.
More precisely, by clicking on the name of a package you invoke the package builder with the old package's metadata already filled in.
The package content itself does not get copied to the new package, so you have to upload a file again.
This limitation is OK for the typical scenario where you deploy a new software version, so you would have to upload a new file anyway.
</p>
<p>
After the new package has been successfully built, it will optionally be deployed to computers which already had the old package marked for deployment.
Then the old package is deleted.
For this reason, the new package needs a different name (typically a different version number appended) because for a brief period of time, both packages exist and package names have to be unique.
If anything goes wrong with building the new package, the old package will not be touched.
</p>

<h4>Additional metadata</h4>

<p>
You can specify a comment and a certificate path.
Both fields are already present in the database and the certificate path is really evaluated, but the original GUI always submits hardcoded defaults (empty comment and 'INSTALL_PATH/cacert.pem').
INSTALL_PATH will be expanded to the agent's installation directory
(like '%PROGRAMFILES%\Ocs Inventory Agent').
You can set any path and filename you like.
The Windows agent also accepts UNC paths (which will probably only work if all clients reside on a local network and the share allows guest access).
This allows some cool stuff like changing the HTTPS server's certificate without breaking deployment.
</p>

<h4>On-the-fly ZIP compression</h4>

<p>
If you want to deploy a single file, having to wrap it into a ZIP archive before uploading can be annoying.
Braintacle creates the archive on the fly if the uploaded file is not a ZIP archive (currently only implemented for Windows packages).
Since the PHP Zip extension's capabilities are limited and ressource usage can grow high for huge files, you can bypass this feature by creating the archive manually before upload, like you always did.
</p>

<h4>Computation of fragment size</h4>

<p>
The original GUI allows specifying both the number of fragments and the fragment size.
Changing one value automatically affects the other.
Braintacle simplifies this process a bit, assuming that you don't want to have a package to have a particular number of fragments, but any number of fragments up to a certain size.
You only specify the maximum fragment size (a default can be provided).
The actual size may be lower because Braintacle splits the package into evenly-sized fragments up to the given limit.
</p>
<p>
Since the maximum fragment size is not stored anywhere (except for the default which may not apply to existing packages), it has to be estimated upon editing.
The result will almost certainly be different from the original value, but still about the same magnitude.
In particular, it would deliver the same number of fragments if the size of the new file had not changed.
</p>

<h4>Upload size limit</h4>

<p>
Braintacle will try to prevent you from uploading a file that is too big to handle.
This is more user-friendly than seeing the script abort prematurely and having to look at the logfiles to find out which one of PHP's limits had been exceeded.
</p>
<p>
The maximum allowed file size is displayed within the package builder.
If this value is too low, adjust the PHP settings.
It is the smallest value of these PHP settings:
</p>
<ul>
<li>100% of upload_max_filesize</li>
<li>90% of post_max_size</li>
<li>80% of memory_limit</li>
</ul>

<h4>Only 1 download server supported</h4>

<p>
Braintacle supports only 1 download server.
This simplifies not only the code, but also the workflow.
The code is written with the assumption that there is only 1 download server per package.
<strong>Having more than 1 download server can give unpredictable results. Use at your own risk!</strong>
<p>
If ressource usage is a problem on your server, you should consider solving the problem outside the application.
For example, you could force usage of a caching proxy on external sites or set up a load balancer.
Once set up this may be easier to handle than having to deal with this everytime you build a new package.
</p>

<h4>Automatic activation</h4>

<p>
The limitation to 1 download server allows package creation and activation to be merged into a single step.
The download locations must be specified at build time, where defaults can be provided.
</p>

<h4>Secure hashes</h4>

<p>
Since MD5 hashes are insecure, SHA1 hashes are used instead.
This is already supported by the agent, but the OCS GUI does not make use of this feature.
</p>

<h4>More reliable connection testing</h4>

<p>
The HTTP and HTTPS connections are checked without using fopen() wrappers.
These checks now work even if allow_url_fopen is disabled.
</p>
<p>
Note that success or failure of these tests does not necessarily mean that the download will or will not work.
Different proxy configuration, firewalls and name resolution may give a different result on the client.
The test results only indicate success or failure on the server that runs Braintacle.
It's up to you to interpret the results.
</p>

<h3><a name="softwarefilter">Software filter</a></h3>

<p>
OCS Inventory provides a function called "software dictionaries" where pieces of installed software can be tagged to be ignored.
This is intended for interaction with <a href="http://www.glpi-project.org/spip.php?lang=en">GLPI</a>.
The OCS Inventory console only provides an interface to define these lists, but does not make use of it.
</p>
<p>
Braintacle honours this list and does not display any software which is tagged to be ignored.
If you already use GLPI and make use of this feature, this behavior might not be desired.
There is an option to display all software anyway.
</p>
<p>
Some software (like MS Office 2007) causes multiple identical entries in a computer's inventory.
These duplicate entries are hidden by default, but can be shown with a single mouseclick if you are really interested.
</p>

<h3>Network management (aka IP discovery)</h3>

<p>
Braintacle uses a different method to determine which network a computer belongs to.
In particular, it takes the netmask into account (for example, 192.168.0.0/16 is different from 192.168.0.0/24)
and also ignores 127.0.0.0/8 completely as this is not a real network.
Additionally, interfaces belonging to an inventoried computer will never show up as unknown, even if the inventory is out of date.
</p>

<h3>Installing packages on a computer</h3>

<p>
Multiple packages can be deployed to a computer at once instead of picking them one by one.
This is particularly convenient for fresh installs where a lot of packages have to be installed.
</p>
<p>
The list of installable packages does not contain already installed packages, which would only end up with ERR_ALREADY_SETUP.
If a package is not in the list, it would not be installable anyway.
This also keeps the list as short as possible.
</p>

<h3>Managing duplicates</h3>

<p>
Braintacle supports a blacklist for asset tags, in addition to serials and MAC addresses.
</p>
<p>
The implementation for merging duplicates is more robust &ndash; no more database errors on weird combinations.
</p>
<p>
The information to be merged can be specified in detail:
</p>
<ul>
<li>
User defined information, if selected, will be preserved from the oldest entry.
</li>
<li>
Manual group assignments, if selected, will be combined from all older entries.
</li>
<li>
Package assignments, if selected, will be combined from all older entries.
The package history is intentionally not preserved.
The typical origin of duplicates is a reinstall, where this would just get in the way.
</li>
</ul>


<h2>Known issues</h2>

<h3>Bad number formatting or PHP notices in package listing</h3>

<p>
On some systems, a message like this is gets logged:
</p>
<pre>
PHP Notice:  Uninitialized string offset:  -1 in /usr/local/share/braintacle/library/Zend/Measure/Abstract.php on line 293
</pre>
<p>
This issue has been reported as <a href="http://framework.zend.com/issues/browse/ZF-9078">ZF-9078</a>.
To get rid of it, install PHP's <i>bcmath</i> extension.
</p>

<h3>Apache gives 404 error on certain operations</h3>

<p>
These strange 404 errors come directly from Apache.
They don't even show up in the error log.
</p>
<p>The source of this problem is the <a href="http://httpd.apache.org/docs/2.2/mod/core.html#allowencodedslashes">AllowEncodedSlashes</a> directive.
If this is disabled (the default), URLs which contain encoded slashes (%2F) trigger this 404.
</p>
<p>
I have not found any information about the purpose of this behavior and the consequences of changing it.
I suppose this is a lame attempt to stop path traversal attacks on poorly written scripts.
</p>
<p>
There are several ways to work around this problem at application level, but they are all very messy.
For this reason, I have not implemented any and the only way to solve this problem is to set <code>AllowEncodedSlashes On</code> for the virtual host.
</p>

<h2>Managing the database schema</h2>

<p>
There are 2 use cases that require different methods for database management.
</p>

<h3>Using Braintacle in addition to an unmodified OCS Inventory installation</h3>

<p>Use the OCS Inventory installer to manage the database.
<strong>Do not use braintacle's schema manager.</strong>
</p>

<h3>Using Braintacle with its bundled OCS Inventory version</h3>

<p>
Braintacle manages the database with the script tools/schema-manager.php.
It uses <a href="http://pear.php.net/package/MDB2_Schema/">MDB2_Schema</a> for this task.
</p>
<p>
The schema is stored in a set of XML fragments in the schema/ directory, one file per table.
Please note that this schema is slightly different from the original schema.
See the
<a href="http://svn.savannah.nongnu.org/viewvc/*checkout*/trunk/schema/README.html?root=braintacle">schema documentation</a>
for details.
</p>
<p>
<strong>
This schema is not fully compatible with the original version of OCS Inventory.
Do not use Braintacle's schema-manager.php if you use an unmodified server.
Manage the schema through the original console application instead.
</strong>
</p>
<p>
The schema manager checks for compatibility with the original version and refuses to update the database in that case.
This can be overridden with the --force option, but compatibility will be lost.
</p>
<p>
The modified version of OCS Inventory that comes bundled with Braintacle works with both schema types.
Its installer uses the same schema as the schema manager script, so the above warning applies too.
It does not check for database compatibility fist.
It is deprecated and not thorougly tested.
Avoid using it.
Use schema-manager.php if possible.
</p>

<h4>Creating the database</h4>

<p>
Creation of the database itself and the database user and setting privileges does not happen automatically.
Log into your database server as superuser and do this manually.
For example, the following commands would work for PostgreSQL:
</p>
<p>
<code>
CREATE USER ocs WITH PASSWORD 'ocs';<br>
CREATE DATABASE ocsweb OWNER ocs ENCODING 'UTF8';
</code>
</p>
<p>
Using Unicode for the database is strongly recommended.
Other encodings may work for the most part, but cause trouble under certain circumstances.
</p>
<p>
Now run the schema manager to create and initialize the tables.
</p>
<p>
<code>php tools/schema-manager.php</code>
</p>

<h4>Updating the database</h4>

<p>
When the schema has changed, just run the schema-manager again.
It will update the tables to the new schema.
I strongly recommend to back up the database before you do this.
Updating a database with MDB2_Schema is a complex operation.
Despite intensive testing and bugfixing, there could always something go wrong.
</p>
<p>
It is safe to run the schema manager more than once, even if the schema has not changed.
It's strongly recommended to run it after every application upgrade.
The script will detect if a schema upgrade is required and perform it, or abort if not.
</p>


<h2>Helper applications</h2>

<p>
The tools directory contains some scripts that are not part of the application, but intended to be invoked directly via command line when needed.
</p>

<h3>schema-manager.php</h3>

<p>
This script is described above.
</p>

<h3><a name="export.php">export.php</a></h3>

<p>
This script exports all computers in the database to the directory specified via the --dir or -d argument.
It will generate 1 XML file per computer.
The generated files can optionally be validated via the --validate or -v switch.
</p>

<h3>createpackage.php</h3>
<p>
This script creates a package from the command line.
This is useful if a file is too big to be uploaded to the webserver.
It can also be used as part of a package builder script.
</p>
<p>
It is limited to the package builder defaults.
Only the name and the file itself can be specified.
</p>
<p>
Don't forget to change permissions/ownership of the generated directory and files.
Otherwise the webserver won't be able to read and/or delete them.
You could also use <code>su</code> to run this script with the UID of the webserver:
</p>
<pre>
su -c 'php tools/createpackage-php PackageName install-Package.exe' www-data
</pre>
<p>
The script is also an example for using the Braintacle API in a different application.
</p>

<h3>update-translation.php</h3>

<p>
This script can be used to maintain the translation files.
It requires xgettext, msgmerge and msgfmt in your search path.
It does 3 things:
</p>

<ol>
<li>
It extracts all translatable strings from the PHP source files and updates languages/braintacle.pot.
This operation can be skipped by passing the <code>--noextract</code> option.<br>
By default, the update is done only if changes to the strings are detected.
If only line numbers have changed, nothing is done in this stage.
An update can be forced with the <code>--force</code> option.
This is useful for developers to keep the line numbers in sync with the source files.
</li>
<li>It updates all .po files in languages/&lt;language&gt;/.</li>
<li>It compiles the .po files to .mo files in languages/&lt;language&gt;/LC_MESSAGES/ which are used by the application.</li>
</ol>

<p>
Run this script everytime you have added translatable stings to the source code or when you have updated the translation.
</p>

<h3>generate-documentation.php</h3>

<p>
This script generates/updates the API documentation.
It requires the phpdoc command in your search path.
The easiest way to install it is through the "pear" command:
</p>
<p>
<code>pear install PhpDocumentor</code>
</p>

</body>
</html>
